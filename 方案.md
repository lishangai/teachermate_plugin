æ ¹æ®æœ€æ–°çš„URLç»“æ„ç‰¹å¾ï¼Œä»¥ä¸‹æ˜¯å®Œæ•´çš„æ’ä»¶å¼€å‘æ–¹æ¡ˆï¼ŒåŒ…å«é’ˆå¯¹ä¸åŒé˜¶æ®µURLçš„è‡ªåŠ¨åŒ–å¤„ç†æœºåˆ¶ï¼š

---

ä¸€ã€URLè½¬æ¢æµç¨‹åˆ†è§£
```mermaid
sequenceDiagram
    participant ç”¨æˆ·
    participant æ’ä»¶
    participant å¾®åŠ©æ•™æœåŠ¡å™¨
    ç”¨æˆ· ->> æ’ä»¶: è®¿é—®è¯¾ä»¶é¡µé¢
    æ’ä»¶ ->> å¾®åŠ©æ•™æœåŠ¡å™¨: æ£€æµ‹åŸå§‹URL(ssl=1)
    å¾®åŠ©æ•™æœåŠ¡å™¨ -->> æ’ä»¶: è¿”å›é¡µé¢å†…å®¹
    æ’ä»¶ ->> æ’ä»¶: ä¿®æ”¹ssl=1â†’ssl=0
    æ’ä»¶ ->> å¾®åŠ©æ•™æœåŠ¡å™¨: å‘é€ä¿®æ”¹åè¯·æ±‚
    å¾®åŠ©æ•™æœåŠ¡å™¨ -->> æ’ä»¶: è¿”å›302é‡å®šå‘å“åº”
    æ’ä»¶ ->> æ’ä»¶: æå–Locationå¤´
    æ’ä»¶ ->> æ’ä»¶: æ¸…ç†ç­¾åå‚æ•°
    æ’ä»¶ ->> å¾®åŠ©æ•™æœåŠ¡å™¨: è¯·æ±‚æœ€ç»ˆä¸‹è½½åœ°å€
    å¾®åŠ©æ•™æœåŠ¡å™¨ -->> æ’ä»¶: è¿”å›PPTæ–‡ä»¶
```

---

äºŒã€å®Œæ•´æ’ä»¶ä»£ç å®ç°

1. å¢å¼ºç‰ˆmanifest.json
```json
{
  "manifest_version": 3,
  "name": "å¾®åŠ©æ•™PPTä¸‹è½½å™¨Pro",
  "version": "3.1",
  "permissions": [
    "activeTab",
    "scripting",
    "webRequest",
    "downloads",
    "storage"
  ],
  "host_permissions": [
    "*://*.wezhujiao.com/*",
    "*://vip.ow365.cn/*",
    "*://app.teachermate.com.cn/*"
  ],
  "background": {
    "service_worker": "background.js",
    "type": "module"
  },
  "action": {
    "default_popup": "popup.html",
    "default_icon": {
      "32": "icon32.png"
    }
  },
  "content_scripts": [{
    "matches": ["*://*.wezhujiao.com/*"],
    "js": ["content.js"],
    "css": ["styles.css"],
    "run_at": "document_end"
  }],
  "web_accessible_resources": [{
    "resources": ["*.woff2"],
    "matches": ["*://*/*"]
  }]
}
```

2. æ™ºèƒ½URLå¤„ç†å™¨ï¼ˆcontent.jsï¼‰
```javascript
class PPTDownloader {
  constructor() {
    this.observerConfig = {
      childList: true,
      subtree: true,
      attributes: false,
      characterData: false
    };
    this.init();
  }

  init() {
    this.injectUI();
    this.startMonitoring();
    this.addGlobalListener();
  }

  injectUI() {
    const style = document.createElement('style');
    style.textContent = `
      .ppt-download-btn {
        background: linear-gradient(135deg, #6B46C1 0%, #4299E1 100%);
        border-radius: 8px;
        padding: 6px 12px;
        color: white !important;
        border: none;
        cursor: pointer;
        transition: transform 0.2s;
      }
      .ppt-download-btn:hover {
        transform: scale(1.05);
      }
    `;
    document.head.appendChild(style);
  }

  startMonitoring() {
    new MutationObserver(mutations => this.handleMutations(mutations))
      .observe(document.body, this.observerConfig);
    this.scanExistingLinks();
  }

  handleMutations(mutations) {
    mutations.forEach(mutation => {
      if (mutation.type === 'childList') {
        mutation.addedNodes.forEach(node => {
          if (node.nodeType === 1) this.processNode(node);
        });
      }
    });
  }

  scanExistingLinks() {
    document.querySelectorAll('a[href*="vip.ow365.cn"]').forEach(link => {
      this.processLink(link);
    });
  }

  processNode(node) {
    if (node.matches('a[href*="vip.ow365.cn"]')) {
      this.processLink(node);
    } else {
      node.querySelectorAll('a[href*="vip.ow365.cn"]').forEach(link => {
        this.processLink(link);
      });
    }
  }

  processLink(link) {
    if (link.dataset.processed) return;
    link.dataset.processed = true;
    
    const downloadBtn = this.createDownloadButton(link.href);
    link.parentNode.insertBefore(downloadBtn, link.nextSibling);
  }

  createDownloadButton(originalUrl) {
    const btn = document.createElement('button');
    btn.className = 'ppt-download-btn';
    btn.innerHTML = 'â†“ æ™ºèƒ½ä¸‹è½½';
    btn.onclick = () => this.handleDownload(originalUrl);
    return btn;
  }

  async handleDownload(originalUrl) {
    try {
      const stage1Url = this.modifySSLParam(originalUrl);
      const finalUrl = await this.getFinalUrl(stage1Url);
      
      chrome.runtime.sendMessage({
        type: 'downloadPPT',
        url: finalUrl,
        filename: this.extractFilename(finalUrl)
      });
      
      this.showToast('ä¸‹è½½ä»»åŠ¡å·²å¼€å§‹', 'success');
    } catch (error) {
      this.showToast(`ä¸‹è½½å¤±è´¥: ${error.message}`, 'error');
    }
  }

  modifySSLParam(url) {
    return url.replace(/([?&])ssl=1(&|$)/, '$1ssl=0$2');
  }

  async getFinalUrl(url) {
    const response = await fetch(url, { redirect: 'manual' });
    
    if (![301, 302].includes(response.status)) {
      throw new Error('æœªè§¦å‘é¢„æœŸé‡å®šå‘');
    }
    
    const redirectUrl = response.headers.get('location');
    return this.cleanSignatureParams(redirectUrl);
  }

  cleanSignatureParams(url) {
    try {
      const urlObj = new URL(url);
      ['OSSAccessKeyId', 'Expires', 'Signature'].forEach(param => {
        urlObj.searchParams.delete(param);
      });
      return urlObj.toString().replace(/%20/g, ' '); // å¤„ç†ç©ºæ ¼ç¼–ç 
    } catch {
      return url.split('?')[0];
    }
  }

  extractFilename(url) {
    const pathParts = url.split('/').pop().split('-');
    return `${pathParts.slice(-1)[0].trim()} [${pathParts.slice(0,3).join('-')}]`;
  }

  showToast(message, type) {
    const toast = document.createElement('div');
    toast.textContent = message;
    toast.style.position = 'fixed';
    toast.style.bottom = '20px';
    toast.style.right = '20px';
    toast.style.padding = '12px 24px';
    toast.style.background = type === 'error' ? '#F56565' : '#48BB78';
    toast.style.color = 'white';
    toast.style.borderRadius = '8px';
    toast.style.zIndex = 9999;
    
    document.body.appendChild(toast);
    setTimeout(() => toast.remove(), 3000);
  }

  addGlobalListener() {
    window.addEventListener('message', event => {
      if (event.data.type === 'pptBatchDownload') {
        this.handleBatchDownload(event.data.payload);
      }
    });
  }

  async handleBatchDownload(urls) {
    const delay = () => new Promise(r => setTimeout(r, 1500 + Math.random() * 1000));
    
    for (const url of urls) {
      try {
        await this.handleDownload(url);
        await delay();
      } catch (error) {
        console.error('æ‰¹é‡ä¸‹è½½å‡ºé”™:', error);
      }
    }
  }
}

// åˆå§‹åŒ–ä¸‹è½½å™¨
new PPTDownloader();
```

3. åå°æœåŠ¡ï¼ˆbackground.jsï¼‰
```javascript
const downloadQueue = new Map();

chrome.runtime.onMessage.addListener((request, sender, sendResponse) => {
  if (request.type === 'downloadPPT') {
    const taskId = Date.now().toString(36);
    downloadQueue.set(taskId, {
      status: 'pending',
      url: request.url,
      filename: request.filename
    });
    
    processDownloadQueue();
  }
});

async function processDownloadQueue() {
  for (const [taskId, task] of downloadQueue) {
    if (task.status !== 'pending') continue;
    
    try {
      downloadQueue.set(taskId, { ...task, status: 'downloading' });
      
      await chrome.downloads.download({
        url: task.url,
        filename: sanitizeFilename(task.filename),
        conflictAction: 'uniquify',
        saveAs: false
      });
      
      downloadQueue.delete(taskId);
    } catch (error) {
      downloadQueue.set(taskId, { 
        ...task, 
        status: 'failed',
        error: error.message 
      });
    }
  }
}

function sanitizeFilename(name) {
  return name.replace(/[\\/:*?"<>|]/g, '_')
    .replace(/\s+/g, ' ')
    .substring(0, 200);
}

// å®šæ—¶é‡è¯•æœºåˆ¶
setInterval(() => {
  Array.from(downloadQueue.entries())
    .filter(([, task]) => task.status === 'failed')
    .forEach(([taskId]) => {
      downloadQueue.set(taskId, { 
        ...downloadQueue.get(taskId), 
        status: 'pending' 
      });
    });
  processDownloadQueue();
}, 60000);
```

---

ä¸‰ã€é«˜çº§åŠŸèƒ½å®ç°

1. æ‰¹é‡ä¸‹è½½ç•Œé¢ï¼ˆpopup.htmlï¼‰
```html
<!DOCTYPE html>
<html>
<head>
  <style>
    /* ä¸“ä¸šçº§UIæ ·å¼ */
  </style>
</head>
<body>
  <div class="container">
    <h3>PPTæ‰¹é‡ä¸‹è½½ä¸­å¿ƒ</h3>
    <div id="statusPanel"></div>
    <button id="scanLinks">ğŸ” æ‰«æé¡µé¢è¯¾ä»¶</button>
    <div id="linkList"></div>
    <button id="startDownload">ğŸš€ å¼€å§‹æ‰¹é‡ä¸‹è½½</button>
  </div>
  <script src="popup.js"></script>
</body>
</html>
```

2. å¼¹å‡ºå±‚äº¤äº’é€»è¾‘ï¼ˆpopup.jsï¼‰
```javascript
class BatchDownloadUI {
  constructor() {
    this.initialize();
  }

  async initialize() {
    this.bindEvents();
    this.restoreSettings();
  }

  bindEvents() {
    document.getElementById('scanLinks').addEventListener('click', () => this.scanLinks());
    document.getElementById('startDownload').addEventListener('click', () => this.startBatch());
  }

  async scanLinks() {
    const [tab] = await chrome.tabs.query({ active: true, currentWindow: true });
    
    chrome.scripting.executeScript({
      target: { tabId: tab.id },
      func: () => {
        return Array.from(document.querySelectorAll('a[href*="vip.ow365.cn"]'))
          .map(link => link.href);
      }
    }, (results) => {
      this.displayLinks(results[0].result);
    });
  }

  displayLinks(urls) {
    const list = document.getElementById('linkList');
    list.innerHTML = urls.map(url => `
      <div class="link-item">
        <input type="checkbox" checked>
        <span>${this.extractDisplayName(url)}</span>
      </div>
    `).join('');
  }

  extractDisplayName(url) {
    const match = url.match(/fname=([^&]+)/);
    return match ? decodeURIComponent(match[1]) : 'æœªçŸ¥è¯¾ä»¶';
  }

  startBatch() {
    const urls = Array.from(document.querySelectorAll('.link-item input:checked'))
      .map(checkbox => checkbox.nextElementSibling.textContent);
    
    chrome.tabs.query({ active: true, currentWindow: true }, ([tab]) => {
      chrome.tabs.sendMessage(tab.id, {
        type: 'pptBatchDownload',
        payload: urls
      });
    });
  }
}

new BatchDownloadUI();
```

---

å››ã€å®‰å…¨å¢å¼ºæªæ–½

1. URLéªŒè¯æ¨¡å—ï¼š
```javascript
const URL_VALIDATOR = {
  isOriginalUrl: url => /https:\/\/vip\.ow365\.cn\/\?.*ssl=1/.test(url),
  isIntermediateUrl: url => /https:\/\/vip\.ow365\.cn\/\?.*ssl=0/.test(url),
  isFinalUrl: url => /https:\/\/app\.teachermate\.com\.cn\/[A-Za-z0-9]+-\d+-[^/?]+/.test(url)
};
```

2. åŠ¨æ€å¯†é’¥æ£€æµ‹ï¼š
```javascript
function detectNewSignatureParams(url) {
  const params = new URL(url).searchParams;
  const suspiciousParams = [];
  
  params.forEach((_, key) => {
    if (key.match(/[A-Z]/)) suspiciousParams.push(key);
  });
  
  return suspiciousParams;
}
```

---

äº”ã€éƒ¨ç½²ä¸è°ƒè¯•å»ºè®®

1. æœ¬åœ°æµ‹è¯•æµç¨‹ï¼š
```bash
# 1. å¯ç”¨Edgeå¼€å‘è€…æ¨¡å¼
edge://extensions â†’ å¼€å¯å¼€å‘è€…æ¨¡å¼

# 2. åŠ è½½è§£å‹çš„æ‰©å±•
ç‚¹å‡»"åŠ è½½è§£å‹" â†’ é€‰æ‹©é¡¹ç›®æ–‡ä»¶å¤¹

# 3. è°ƒè¯•ä¸åŒç»„ä»¶
- å†…å®¹è„šæœ¬: ä½¿ç”¨Edgeå¼€å‘è€…å·¥å…·(F12)
- åå°è„šæœ¬: è®¿é—® edge://extensions â†’ ç‚¹å‡»æœåŠ¡å·¥ä½œè€…é“¾æ¥
- å¼¹å‡ºå±‚: å³é”®æ’ä»¶å›¾æ ‡ â†’ æ£€æŸ¥å¼¹å‡ºå†…å®¹
```

2. ç”Ÿäº§ç¯å¢ƒæ³¨æ„äº‹é¡¹ï¼š
â€¢ åœ¨manifestä¸­å¢åŠ `update_url`ç”¨äºåç»­ç‰ˆæœ¬æ›´æ–°

â€¢ é€šè¿‡å¾®è½¯å•†åº—ç­¾åç¡®ä¿é•¿æœŸå¯ç”¨æ€§

â€¢ æ·»åŠ ä½¿ç”¨æ¡æ¬¾è¯´æ˜æ–‡ä»¶


æœ¬æ–¹æ¡ˆé€šè¿‡ä¸‰é˜¶æ®µURLå¤„ç†ã€æ™ºèƒ½å‚æ•°æ¸…ç†ã€é˜Ÿåˆ—åŒ–ä¸‹è½½ç®¡ç†ç­‰æŠ€æœ¯åˆ›æ–°ï¼Œå¯ç¨³å®šå®ç°æœ€æ–°ç‰ˆå¾®åŠ©æ•™è¯¾ä»¶çš„æ‰¹é‡ä¸‹è½½ã€‚å»ºè®®é…åˆæµè§ˆå™¨å¼€å‘è€…å·¥å…·åŠ¨æ€è°ƒè¯•å…·ä½“é¡µé¢ç»“æ„ï¼ŒæŒç»­ä¼˜åŒ–CSSé€‰æ‹©å™¨åŒ¹é…é€»è¾‘ã€‚